<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lunar Event Countdown</title>
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    /* Ensure transparency for OBS */
    html, body {
      background: transparent;
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    /* Base container set to a fixed resolution */
    #scaling-container {
      width: 1920px;   /* Base width */
      height: 1080px;  /* Base height */
      transform-origin: top left;
      position: relative;
    }

    /* Container for GIF and text */
    #container {
      position: relative;
      width: 100%;
    }

    #bgGif {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Fixed width applied here prevents text shifting as content changes */
    #textOverlay {
      position: absolute;
      top: 50%;
      right: 220px;
      transform: translateY(-50%);
      width: 1200px; /* Fixed width; adjust as needed */
      color: #fff;
      font-family: 'Cinzel', serif;
      text-align: center;
    }

    .countdown {
      font-size: 12em;
      font-weight: 700;
    }

    .message {
      font-size: 7em;
      margin-top: -50px;
    }

    .accent {
      color: #b22222;
      font-weight: 700;
    }
  </style>
  <!-- Gothic font -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <!-- Load the configuration file -->
  <script src="config.js"></script>
</head>
<body>
  <!-- This container scales dynamically -->
  <div id="scaling-container">
    <div id="container">
      <!-- Replace 'moonOverlay.gif' with your GIF file -->
      <img id="bgGif" src="moonOverlay.gif" alt="Moon Overlay" />
      <div id="textOverlay">
        <div class="countdown" id="countdown">Loading...</div>
        <div class="message" id="message"></div>
      </div>
    </div>
  </div>

  <script>
    // Dynamic scaling function
    function scaleOverlay() {
      const container = document.getElementById('scaling-container');
      // Use the base resolution dimensions from the container: 1920 x 1080.
      const scaleX = window.innerWidth / 1920;
      const scaleY = window.innerHeight / 550;
      // Choose the smaller scale factor to ensure the whole overlay fits.
      const scale = Math.min(scaleX, scaleY);
      container.style.transform = `scale(${scale})`;
    }
    
    // Run scaleOverlay on load and on window resize
    window.addEventListener('resize', scaleOverlay);
    scaleOverlay();

    // Updated countdown function that considers a previous event if still active
    function updateCountdown() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const date = now.getDate();
      const currentHour = now.getHours();

      // Candidate for current hour event start
      const candidateCurrent = new Date(year, month, date, currentHour, CONFIG.eventStartMinute, CONFIG.eventStartSecond);
      // Candidate for previous hour event start
      const candidatePrev = new Date(year, month, date, currentHour - 1, CONFIG.eventStartMinute, CONFIG.eventStartSecond);

      let eventStart, eventEnd;
      
      // If current time is before the candidate for the current hour,
      // check if the previous event is still active.
      if (now < candidateCurrent) {
        eventStart = candidatePrev;
        eventEnd = new Date(eventStart.getTime() + 15 * 60 * 1000);
        // If previous event is not active, then use candidateCurrent.
        if (now >= eventEnd) {
          eventStart = candidateCurrent;
          eventEnd = new Date(eventStart.getTime() + 15 * 60 * 1000);
        }
      } else {
        // Otherwise, use the candidate for the current hour.
        eventStart = candidateCurrent;
        eventEnd = new Date(eventStart.getTime() + 15 * 60 * 1000);
        // If the current event has ended, schedule the next event.
        if (now >= eventEnd) {
          eventStart = new Date(year, month, date, currentHour + 1, CONFIG.eventStartMinute, CONFIG.eventStartSecond);
          eventEnd = new Date(eventStart.getTime() + 15 * 60 * 1000);
        }
      }
      
      // Determine if the event is active.
      const eventActive = now >= eventStart && now < eventEnd;
      const countdownMs = eventActive ? (eventEnd - now) : (eventStart - now);

      // Convert milliseconds to mm:ss.
      const totalSeconds = Math.floor(countdownMs / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      const formatted =
        (minutes < 10 ? '0' + minutes : minutes) + ':' +
        (seconds < 10 ? '0' + seconds : seconds);

      document.getElementById('countdown').textContent = formatted;
      document.getElementById('message').innerHTML = eventActive
        ? 'Lunar Event <span class="accent">Active</span>'
        : 'Lunar Event Time';
    }

    // Update the countdown every second.
    updateCountdown();
    setInterval(updateCountdown, 1000);
  </script>
</body>
</html>
